angular.module("myApp.locomotive-reports-add",["ngRoute","authentication-factory","uiGmapgoogle-maps","geocode-service","mgcrea.ngStrap.datepicker","mgcrea.ngStrap.typeahead"]).config(["$routeProvider","uiGmapGoogleMapApiProvider","$datepickerProvider",function(a,b,c){a.when("/reports/new",{controller:"LocomotiveReportNewCtrl",templateUrl:"add-locomotive-report/add-locomotive-report.html",resolve:{currentAuth:["Auth","$location",function(a,b){return a.$requireAuth()}]}}).when("/:locomotiveNumber/reports/new",{controller:"LocomotiveReportNewCtrl",templateUrl:"add-locomotive-report/add-locomotive-report.html",resolve:{currentAuth:["Auth","$location",function(a,b){return a.$requireAuth()}]}}),angular.extend(c.defaults,{dateFormat:"MM/dd/yyyy",autoclose:!0})}]).controller("LocomotiveReportNewCtrl",["$scope","$location","$window","LocomotiveReport","uiGmapIsReady","GeoCode","currentAuth","Auth","$routeParams",function(a,b,c,d,e,f,g,h,i){h.$onAuth(function(a){a||returnToReportsPage()}),angular.isDefined(i.locomotiveNumber)&&(a.locomotive=i.locomotiveNumber),a.locomotives=[],a.map={center:{latitude:0,longitude:0},zoom:18,events:{dragend:function(a,b,c){a.getCenter().lat(),a.getCenter().lng()},dblclick:function(b,c,d){var e=d[0].latLng;a.marker.coords.longitude=e.lng(),a.marker.coords.latitude=e.lat(),b.setCenter(e),getAddressFromLatLng(e.lat(),e.lng())}}},a.marker={id:1,coords:{longitude:0,latitude:0},options:{draggable:!0},events:{dragend:function(a,b,c,d){var e=a.getPosition().lat(),f=a.getPosition().lng();getAddressFromLatLng(e,f)}}},a.datePickerOptions={autoclose:!0,orientation:"auto",todayHighlight:!0},a.dateSpotted=new Date,getAddressFromLatLng=function(b,c){f.getAddress(b,c).success(function(b){b.results.length>0&&(a.location=b.results[0].formatted_address,a.address=b.results[0])}).error(function(a){})},updateCurrentPosition=function(b){var c={latitude:b.coords.latitude,longitude:b.coords.longitude},d={latitude:b.coords.latitude,longitude:b.coords.longitude};a.map.center=c,a.marker.coords=d,getAddressFromLatLng(b.coords.latitude,b.coords.longitude)},e.promise().then(function(a){c.navigator.geolocation.getCurrentPosition(updateCurrentPosition)}),a.submitReport=function(b){if(!b.$invalid){var c={locomotiveNumber:angular.isObject(a.locomotive)?a.locomotive.name:a.locomotive,dateSpotted:a.dateSpotted.toJSON(),location:a.marker.coords,address:a.location,reportedBy:g.uid,reported:(new Date).toJSON(),comments:a.comments};d.Add(c).then(function(b){a.returnToReportsPage()})}},a.updateMap=function(){f.getCoords(a.location).success(function(a){if(!(a.results.length<1)){var b=a.results[0].geometry.location,c={coords:{latitude:b.lat,longitude:b.lng}};updateCurrentPosition(c)}}).error(function(a){})},a.returnToReportsPage=function(){angular.isDefined(i.locomotiveNumber)?b.path("/"+i.locomotiveNumber+"/reports"):c.history.back()},d.GetAllLocomotives().then(function(b){a.locomotives=b})}]),angular.module("myApp",["ngRoute","ngMessages","modify-item-directive","item-service","list-item-directive","authentication-factory","uiGmapgoogle-maps","myApp.main","myApp.lists","myApp.navbars","myApp.login","myApp.register","myApp.locomotive-reports","myApp.reports","myApp.recent-reports","myApp.locomotive-reports-add"]).run(["$rootScope","$location",function(a,b){a.$on("$routeChangeError",function(a,c,d,e){"AUTH_REQUIRED"===e&&b.path("/login"+c.$$route.originalPath)}),a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)}}]).constant("GoogleApiKey","AIzaSyB4g4PaWdcZcM0rEFh2DC4FJiO6MHqMAHg").constant("FirebaseUrl","https://nitrous-demo.firebaseio.com").constant("FirebaseUrlx","https://locomotive.firebaseio.com").config(["$routeProvider","$locationProvider","uiGmapGoogleMapApiProvider","GoogleApiKey",function(a,b,c,d){a.otherwise({redirectTo:"/reports"}),b.html5Mode(!0),c.configure({key:d,v:"3.19"})}]),angular.module("date-picker",[]).directive("datePicker",[function(){return{restrict:"A",link:function(a,b,c){angular.element(b).datepicker(a[c.datePicker])}}}]),angular.module("list-item-directive",[]).directive("listItem",["itemService",function(a){return{restrict:"E",templateUrl:"components/directives/list-item/list-item.html",scope:{items:"=",selectedItem:"=",options:"="},controller:["$scope",function(b){b["delete"]=function(b){a.removeItem(b)},b.edit=function(a){b.selectedItem=a}}]}}]),angular.module("modify-item-directive",[]).directive("modifyItem",["itemService",function(a){return{restrict:"E",templateUrl:"components/directives/modify-item/modify-item.html",scope:{items:"=listItems",selectedItem:"="},controller:["$scope",function(b){b.$watch("selectedItem",function(a){b.currentItem=angular.copy(b.selectedItem)}),b.beginItemAdd=function(){b.isAdd=!0},b.save=function(){b.isAdd?a.addItem(b.currentItem):(b.selectedItem.value=b.currentItem.value,a.editItem(b.selectedItem)),b.cancelEdit()},b.cancelEdit=function(){b.showForm=!1,b.currentItem=null,b.selectedItem=null,b.isAdd=!1,b.isEdit=!1}}],link:function(a,b,c){}}}]),angular.module("authentication-factory",["firebase","user-factory"]).factory("Auth",["$firebaseAuth","$rootScope","$location","User","FirebaseUrl",function(a,b,c,d,e){var f=new Firebase(e),g=a(f);return g.ref=f,g.$onAuth(function(a){if(a)switch(b.auth=a,a.provider){case"password":b.isPassword=!0,b.user=d.GetUser(a.uid);break;case"google":b.isGoogle=!0,b.user=d.UpdateUser(a.uid,a.google);break;case"facebook":b.isFacebook=!0,b.user=d.UpdateUser(a.uid,a.facebook)}else b.auth=null,b.user=null}),g.login=function(a,b){switch(a){case"password":return g.$authWithPassword(b);default:return g.$authWithOAuthPopup(a,b)}},g.logout=function(){g.$unauth()},g}]),angular.module("locomotive-factory",["firebase"]).factory("LocomotiveReport",["$firebaseObject","$firebaseArray","$q","$rootScope","FirebaseUrl",function(a,b,c,d,e){var f=e+"/locomotives",g=e+"/locomotive-reports",h=new Firebase(e),i=[],j=[],k=function(a){var c=new Firebase(f+a.locomotiveNumber);c.once("value",function(b){b.exists()||new Firebase(f).child(a.locomotiveNumber).set({name:a.locomotiveNumber})});var d=new Firebase(g);return b(d).$add(a)},l=function(b,c){var d=h.child(b);return d.set(c),a(d)},m=function(a){var b=i.$getRecord(a.$id);return i.$remove(b)},n=function(){var a=c.defer(),b=new Firebase(g);return b.once("value",function(b){i.length=0;for(var c in Object.keys(b.val())){var e=b.val()[Object.keys(b.val())[c]];e.id=Object.keys(b.val())[c],e.options={labelContent:e.locomotiveNumber,labelClass:"marker-label"},i.push(e)}a.resolve(i),d.safeApply()}),a.promise},o=function(a){var b=c.defer();new Firebase(g).orderByChild("locomotiveNumber").equalTo(a).on("value",function(a){if(j.length=0,null!==a.val()){for(var c in Object.keys(a.val())){var e=a.val()[Object.keys(a.val())[c]];e.id=Object.keys(a.val())[c],e.options={labelContent:e.address,labelClass:"marker-label"},j.push(e)}j.sort(function(a,b){return a.dateSpotted<b.dateSpotted?-1:a.dateSpotted>b.dateSpotted?1:0}),b.resolve(j),d.safeApply()}});return b.promise},p=function(){var a=c.defer(),b=new Firebase(f),e=[];return b.orderByChild("name").on("value",function(b){e.length=0,b.forEach(function(a){e.push(a.val())}),a.resolve(e),d.safeApply()}),a.promise},q=function(){var a=c.defer(),b=new Firebase(g);return b.on("value",function(c){i.length=0;new Firebase(f).once("value",function(c){c.forEach(function(a){b.orderByChild("locomotiveNumber").equalTo(a.key()).once("value",function(a){if(null!==a.val()){var b=[];for(var c in Object.keys(a.val())){var d=a.val()[Object.keys(a.val())[c]];d.id=Object.keys(a.val())[c],d.numberOfReports=Object.keys(a.val()).length,d.options={labelContent:d.locomotiveNumber,labelClass:"marker-label"},b.push(d)}i.push(b.reduce(function(a,b){var c=a.dateSpotted>=b.dateSpotted?a:b;return c}))}})}),a.resolve(i),d.safeApply()})}),a.promise};return{Add:k,Update:l,Remove:m,GetAllReports:n,GetReportByLocomotiveNumber:o,GetAllRecentReports:q,Reports:i,ReportsByLocomotiveNumber:j,GetAllLocomotives:p}}]),angular.module("user-factory",["firebase"]).factory("User",["$firebaseObject","FirebaseUrl",function(a,b){var c=new Firebase(b+"/users"),d=function(b){var d=c.child(b);return a(d)},e=function(b,d){var e=c.child(b);return e.set(d),a(e)};return{GetUser:d,UpdateUser:e}}]),angular.module("geocode-service",[]).service("GeoCode",["$http","GoogleApiKey",function(a,b){this.getAddress=function(c,d){return a({url:"https://maps.googleapis.com/maps/api/geocode/json",method:"GET",params:{latlng:c+","+d,key:b}})},this.getCoords=function(c){return a({url:"https://maps.googleapis.com/maps/api/geocode/json",method:"GET",params:{address:c,key:b}})}}]),angular.module("id-service",[]).service("idService",[function(){var a=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()};this.Guid=function(){return a()}}]),angular.module("item-service",["firebase"]).service("itemService",["$firebaseArray",function(a){var b=new Firebase("https://nitrous-demo.firebaseio.com/items"),c=a(b);this.addItem=function(a){c.$add(a)},this.removeItem=function(a){c.$remove(a)},this.editItem=function(a){c.$save(a)},this.items=function(){return c}}]),angular.module("myApp.lists",["ngRoute","authentication-factory"]).config(["$routeProvider",function(a){a.when("/lists",{controller:"ListsCtrl",templateUrl:"lists/lists.html",resolve:{currentAuth:["Auth","$location",function(a,b){return a.$requireAuth()}]}})}]).controller("ListsCtrl",["$scope","itemService","currentAuth","$location","Auth",function(a,b,c,d,e){a.items=b.items(),a.newItem=null,a.selectedItem=null}]),angular.module("myApp.locomotive-reports",["ngRoute","authentication-factory","locomotive-factory","geocode-service"]).config(["$routeProvider",function(a){a.when("/:locomotiveNumber/reports",{controller:"LocomotiveReportsCtrl",templateUrl:"locomotive-reports/locomotive-reports.html"})}]).controller("LocomotiveReportsCtrl",["$scope","$routeParams","LocomotiveReport","GeoCode","$window","uiGmapIsReady",function(a,b,c,d,e,f){a.locomotiveNumber=b.locomotiveNumber,a.locomotiveReports=[],f.promise().then(function(b){c.GetReportByLocomotiveNumber(a.locomotiveNumber).then(function(b){a.locomotiveReports=b})}),a.map={center:{latitude:"40.1451",longitude:"-99.6680"},zoom:4,markerEvents:{mouseover:function(a,b,c,d){},mouseout:function(a,b,c,d){}}},a.goBack=function(){e.history.back()}}]),angular.module("myApp.login",["ngRoute","authentication-factory"]).config(["$routeProvider",function(a){a.when("/login",{controller:"LoginCtrl",templateUrl:"login/login.html",reloadOnSearch:!1}).when("/login/:redirect",{controller:"LoginCtrl",templateUrl:"login/login.html"})}]).controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){function d(a){c.path("/")}a.loginWithPassword=function(){b.login("password",a.user).then(d)["catch"](function(b){a.errorMessage="Invalid email or password"})},a.loginWithGoogle=function(){b.login("google",{scope:"profile"}).then(d)["catch"](function(b){a.errorMessage="Invalid Google login"})},a.loginWithFacebook=function(){b.login("facebook").then(d)["catch"](function(b){a.errorMessage="Invalid Facebook login"})}}]),angular.module("myApp.main",["ngRoute","uiGmapgoogle-maps","locomotive-factory"]).config(["$routeProvider",function(a){}]).controller("MainCtrl",["$scope","Auth","LocomotiveReport","uiGmapIsReady",function(a,b,c,d){a.reports=[],d.promise().then(function(b){c.GetAllReports().then(function(b){a.reports=b})}),a.map={center:{latitude:"40.1451",longitude:"-99.6680"},zoom:4}}]),angular.module("myApp.navbars",["authentication-factory","mgcrea.ngStrap.navbar"]).controller("NavBarCtrl",["$scope","$location","Auth","$rootScope",function(a,b,c,d){a.loginWithPassword=function(a){c.login("password",a)},a.loginWithFacebook=function(){c.login("facebook")},a.loginWithGoogle=function(){var a={scope:"profile"};c.login("google",a)},a.logout=function(){c.logout()}}]),angular.module("myApp.recent-reports",["ngRoute","authentication-factory","locomotive-factory"]).config(["$routeProvider",function(a){a.when("/reports",{controller:"AllRecentReportsCtrl",templateUrl:"recent-reports/recent-reports.html"})}]).controller("AllRecentReportsCtrl",["$scope","LocomotiveReport","uiGmapIsReady",function(a,b,c){function d(a){}function e(a){}a.locomotiveReports=[],a.deleteReport=function(a){reportService.deleteReport(a).success(function(){getAllReports()})},a.deleteSelectedReports=function(){for(var c=a.locomotiveReports.filter(function(a){return a.selected===!0}),f=0;f<c.length;f++){var g=c[f];delete g.selected,b.Remove(c[f]).then(d)["catch"](e)}},a.showDeleteButton=function(){return a.numberOfSelectedReports()>0},a.numberOfSelectedReports=function(){var b=0;if(void 0!==a.locomotiveReports)for(i=0;i<a.locomotiveReports.length;i++)a.locomotiveReports[i].selected&&b++;return b},a.deleteButtonText=function(){var b="Delete selected report";return a.numberOfSelectedReports()>1&&(b+="s"),b},c.promise().then(function(c){b.GetAllRecentReports().then(function(b){a.locomotiveReports=b})}),a.map={center:{latitude:"40.1451",longitude:"-99.6680"},zoom:4,markerEvents:{mouseover:function(a,b,c,d){},mouseout:function(a,b,c,d){}}}}]),angular.module("myApp.register",["ngRoute","authentication-factory"]).config(["$routeProvider",function(a){a.when("/register",{controller:"RegisterCtrl",templateUrl:"register/register.html"})}]).controller("RegisterCtrl",["$scope","Auth","$location",function(a,b,c){a.register=function(){var d={email:a.user.email,password:a.user.password};b.$createUser(d).then(function(e){b.$authWithPassword(d).then(function(b){a.user.provider=b.provider,delete a.user.password;var d=new Firebase("https://nitrous-demo.firebaseio.com/");d.child("users").child(e.uid).set(a.user),c.path("/main")})["catch"](function(a){console.log("Error: ",a)})})["catch"](function(a){console.log("Error: ",a)})}}]),angular.module("myApp.reports",["ngRoute","authentication-factory","locomotive-factory"]).config(["$routeProvider",function(a){a.when("/reports/all",{controller:"AllReportsCtrl",templateUrl:"reports/reports.html"})}]).controller("AllReportsCtrl",["$scope","LocomotiveReport","uiGmapIsReady",function(a,b,c){function d(a){}function e(a){}a.locomotiveReports=[],a.deleteReport=function(a){reportService.deleteReport(a).success(function(){getAllReports()})},a.deleteSelectedReports=function(){for(var c=a.locomotiveReports.filter(function(a){return a.selected===!0}),f=0;f<c.length;f++){var g=c[f];delete g.selected,b.Remove(c[f]).then(d)["catch"](e)}},a.showDeleteButton=function(){return a.numberOfSelectedReports()>0},a.numberOfSelectedReports=function(){var b=0;if(void 0!==a.locomotiveReports)for(i=0;i<a.locomotiveReports.length;i++)a.locomotiveReports[i].selected&&b++;return b},a.deleteButtonText=function(){var b="Delete selected report";return a.numberOfSelectedReports()>1&&(b+="s"),b},c.promise().then(function(c){b.GetAllReports().then(function(b){a.locomotiveReports=b})}),a.map={center:{latitude:"40.1451",longitude:"-99.6680"},zoom:4,markerEvents:{mouseover:function(a,b,c,d){},mouseout:function(a,b,c,d){}}}}]);