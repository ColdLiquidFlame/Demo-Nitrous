<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/web-animations/2.2.2/web-animations-next-lite.min.js"></script>
<dom-module id="my-login">
    <template>
        <style>
            #profile-pic {
                width: 32px;
                height: 32px;
                border-radius: 50%;
            }
        </style>
        
        <firebase-auth 
            id="auth" 
            user="{{ user }}"
            signed-in="{{ signedIn }}"  
            provider="google"
            scope="profile"
            app="[[ firebaseApp ]]"></firebase-auth>

        <firebase-document
            id="userDoc"
            path="/users/google:{{ user.uid }}"
            data="{{ userInfo }}"
            transactions-complete="handleTransactionsComplete"
            app="[[ firebaseApp ]]"></firebase-document>

        <div id="login" on-click="login" hidden$="{{ signedIn }}">
            <paper-item>Sign In</paper-item>
        </div>
        <div id="logout" hidden$="{{ !signedIn }}">
            <paper-menu-button>
                <paper-item slot="dropdown-trigger">
                    <iron-image
                        id="profile-pic"
                        sizing="contain"
                        src="[[user.photoURL]]">
                    </iron-image>
                    &nbsp;
                    [[ user.displayName ]]
                </paper-item>
                <paper-listbox slot="dropdown-content">
                    <paper-item on-click="logout">Sign Out</paper-item>
                </paper-listbox>
            </paper-menu-button>
        </div>
    </template>
    <script>
        class MyLogin extends Polymer.Element {
            static get is() {
                return "my-login";
            }

            static get properties() {
                return {
                    user: Object,
                    spot: String,
                    firebaseApp: Object,
                    signedIn: {
                        type: Boolean,
                        notify: true,
                        reflectToAttribute: true
                    }
                }
            }

            static get observers() {
                return ['_userInfoChanged(userInfo, user)'];
            }

            login() {
                var self = this;
                this.$.auth.signInWithPopup()
                    .then(function(response) {
                        console.log(response);
                        console.log("user: " + self.user);
                    }) // optionally handle a successful login})
                    .catch(function(error) {
                        console.log(error);
                    }); // unsuccessful authentication response here});
            }

            logout() {
                this.$.auth.signOut()
                    .then(function(response) {
                        console.log(response);
                    }) // optionally handle a successful login})
                    .catch(function(error) {
                        console.log(error);
                    }); // unsuccessful authentication response here});
            }

            handleTransactionsComplete(response) {
                console.log("Transaction Complete");
                console.log(response);

                debugger;
            }

            _userInfoChanged(userInfo, user) {
                if (userInfo === undefined || userInfo === null || user === undefined || user === null)
                    return;

                userInfo.displayName = user.displayName;
                userInfo.email = user.email;
                userInfo.photoURL = user.photoURL;

                this.$.userDoc.saveValue("/users", user.uid);
            }
        }

        window.customElements.define(MyLogin.is, MyLogin);
    </script>
</dom-module>